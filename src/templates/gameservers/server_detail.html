{% extends "base_site.html" %}
{% load staticfiles %}

{% block title %}
    {{server}}
{% endblock %}

{% block content %}
    <h1>{{server}}</h1>

    <a class="btn btn-default" href="{{server.game_url}}" rel="nofollow">Launch game</a>
    {% if server.site_url %}
        <a class="btn btn-default" href="{{server.site_url}}" rel="nofollow">Homepage</a>
    {% else %}
        <button class="btn btn-default">No homepage</button>
    {% endif %}

    <h3>Players</h3>
    <p>Last updated <span class="bold" title="{{server.last_updated|date:'r'}} GMT">
        {{server.last_updated|timesince}}
    </span>ago.</p>

    <table class="table table-hover">
        <tbody>
        {% if server.players_current > 0 %}
            <tr class="success">
        {% else %}
            <tr class="danger">
        {% endif %}
                <th>Current</th>
                <th>{{server.players_current}}</th>
            </tr>
            <tr>
                <th>Average</th>
                <th>{{server.players_avg}}</th>
            </tr>
            <tr>
                <th>Min</th>
                <th>{{server.players_min}}</th>
            </tr>
            <tr>
                <th>Max</th>
                <th>{{server.players_max}}</th>
            </tr>
    </table>

    <h3>Players last week</h3>
    <div id="weekly_history"></div>
    <h3>Average per day</h3>
    <div id="weekday_averages"></div>
    <div id="tooltip"></div>

    <script type="text/javascript" src="{% static 'js/jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.flot.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.flot.time.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.flot.categories.js' %}"></script>
    <script type="text/javascript">
        $(function() {
            var data = [
                {# convert timestamp to ms, because javascript... #}
                {% for item in weekly_history %}
                    [{{item.created|date:'U'}} * 1000, {{item.players}}],
                {% endfor %}
            ];
            $.plot("#weekly_history", [data], {
                xaxis: {
                    mode: "time",
                    timezone: "browser",
                },
                lines: {
                    show: true,
                    fill: true,
                },
                grid: {
                    hoverable: true,
                    borderWidth: 0,
                },
            });

            var data= [
                {% for day, players in averages_for_weekdays %}
                    ["{{day}}", {{players}}],
                {% endfor %}
            ];
            $.plot("#weekday_averages", [data], {
                xaxis: {
                    mode: "categories",
                },
                bars: {
                    show: true,
                    barWidth: 0.75,
                    align: "center",
                },
                grid: {
                    hoverable: true,
                    borderWidth: 0,
                },
            });

            $("#weekly_history").bind("plothover", function (event, pos, item) {
                if (item) {
                    var time = item.datapoint[0];
                    var players = item.datapoint[1];
                    var timestamp = new Date(time).toString();
                    $("#tooltip")
                        .html(players + " players at " + timestamp)
                        .css({top: item.pageY+5, left: item.pageX+5})
                        .fadeIn(200);
                } else {
                    $("#tooltip").hide();
                }
            });
            $("#weekday_averages").bind("plothover", function (event, pos, item) {
                if (item) {
                    var players = item.datapoint[1];
                    $("#tooltip")
                        .html(players + " players")
                        .css({top: item.pageY+5, left: item.pageX+5})
                        .fadeIn(200);
                } else {
                    $("#tooltip").hide();
                }
            });
        });
    </script>
{% endblock %}

